<html>
	<head>
		<title>Welcome to NIO Runtime Httpd Server!</title>
	</head>
	<script src='/js/ser.js'></script>
	<body>
		Test WS
		<script>
			function getCookie(cname) {
				let name = cname + "=";
				let decodedCookie = decodeURIComponent(document.cookie);
				let ca = decodedCookie.split(';');
				for(let i = 0; i <ca.length; i++) {
					let c = ca[i];
					while (c.charAt(0) == ' ') {
						c = c.substring(1);
					}
					if (c.indexOf(name) == 0) {
						return c.substring(name.length, c.length);
					}
				}
				return "";
			}

			//var token = BigInt(getCookie("auth"));
			var token = BigInt("155836489535448287648775751004424988888");
			var sock = new WebSocket("ws://localhost:8093/ws");
			sock.binaryType = "arraybuffer";
			sock.onclose = function(ev) {
				console.log("websocket closed");
			}
			sock.onmessage = function (ev) {
				var buffer = new Uint8Array(ev.data);
				var recv_event = array_buffer_to_event(buffer);
				console.log("recv_event.event_type = " + recv_event.event_type);
				if(recv_event.event_type == EVENT_TYPE_AUTH_RESP) {
					console.log("auth_resp.success = " + recv_event.auth_resp.value.success);
					var event = new Event(
						EVENT_TYPE_GET_SERVERS_EVENT,
					);
					let challenge = event.serialize(event);
					sock.send(challenge);
				}
				else if(recv_event.event_type == EVENT_TYPE_CHALLENGE) {
					var event = new Event(
						EVENT_TYPE_AUTH,
						new AuthEvent(
							new SerOption(),
							new SerOption(
								token,
							),
							new SerOption(),
						)
					);

					let resp_buffer = event.serialize(event);
					sock.send(resp_buffer);
				} else if(recv_event.event_type == EVENT_TYPE_GET_SERVERS_RESPONSE) {
					for(var i=0; i<recv_event.get_servers_response.value.servers.length; i++) {
						console.log(recv_event.get_servers_response.value.servers[i].name);
						console.log(recv_event.get_servers_response.value.servers[i].description);
						console.log(recv_event.get_servers_response.value.servers[i].server_id);
						console.log(recv_event.get_servers_response.value.servers[i].server_pubkey);
					}
				}
			}
		</script>
	</body>
</html>
